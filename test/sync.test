test:
	spawn on node1 as p1
	spawn on node2 as p2
	send "watch-local-identity" to p1
	send "watch-local-identity" to p2
	send "watch-shared-identity" to p1
	send "watch-shared-identity" to p2
	send "create-identity Device1 Owner" to p1
	send "create-identity Device2" to p2
	send "start-server" to p1
	send "start-server" to p2
	expect /local-identity Device1 Owner/ from p1
	expect /local-identity Device2/ from p2
	expect /shared-identity Owner/ from p1
	expect /peer [0-9]+ 192.168.0.12:29665/ from p1
	expect /peer [0-9]+ 192.168.0.11:29665/ from p2
	expect /peer [0-9]+ Device2 Device2/ from p1
	expect /peer [0-9]+ Owner Device1/ from p2

	send "attach Owner" to p2
	expect /attach-confirm .*/ from p1
	expect /attach-confirm .*/ from p2
	# TODO: check code match

	send "attach-accept Device2 1" to p1
	send "attach-accept Owner 1" to p2
	expect /attach-result Device2 1/ from p1
	expect /attach-result Owner 1/ from p2
	expect /local-identity Device2 Owner/ from p2
	expect /shared-identity Owner/ from p2
	expect /peer [0-9]+ Owner Device2/ from p1

	send "update-shared-identity NewOwner" to p1
	expect /shared-identity NewOwner/ from p1
	expect /shared-identity NewOwner/ from p2

	send "update-shared-identity NewOwner2" to p2
	expect /shared-identity NewOwner2/ from p1
	expect /shared-identity NewOwner2/ from p2

	send "update-shared-identity NewOwner3" to p1
	expect /shared-identity NewOwner3/ from p1
	expect /shared-identity NewOwner3/ from p2
